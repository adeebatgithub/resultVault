<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ResultVault</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0d0d0d;--surface:#141414;--card:#1a1a1a;--border:#2a2a2a;
      --accent:#c8f060;--accent2:#60d4f0;--text:#f0ede8;
      --muted:#6a6a6a;--danger:#f06060;--pass:#60f090;
    }
    body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;min-height:100vh;overflow-x:hidden}
    body::before{content:'';position:fixed;inset:0;
      background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
      background-size:40px 40px;opacity:0.35;pointer-events:none;z-index:0}

    .wrap{position:relative;z-index:1;max-width:940px;margin:0 auto;padding:40px 24px 80px}

    /* â”€â”€ HEADER â”€â”€ */
    header{display:flex;align-items:flex-end;justify-content:space-between;
      margin-bottom:44px;padding-bottom:24px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:12px}
    .logo h1{font-family:'DM Serif Display',serif;font-size:2.5rem;line-height:1;letter-spacing:-0.02em}
    .logo h1 em{color:var(--accent);font-style:normal}
    .logo p{font-size:0.68rem;color:var(--muted);margin-top:5px;letter-spacing:0.14em;text-transform:uppercase}
    .header-pills{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{font-size:0.62rem;font-weight:500;letter-spacing:0.1em;text-transform:uppercase;padding:5px 11px;border-radius:2px}
    .pill-public{background:var(--surface);border:1px solid var(--border);color:var(--muted)}
    .pill-admin{background:rgba(200,240,96,.1);border:1px solid rgba(200,240,96,.35);color:var(--accent)}
    .pill-admin::before{content:'â—† ';font-size:0.5rem;animation:blink 2s infinite}
    .pill-file{background:rgba(96,212,240,.07);border:1px solid rgba(96,212,240,.25);color:var(--accent2)}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

    /* â”€â”€ TABS â”€â”€ */
    .tabs{display:flex;gap:4px;margin-bottom:32px;background:var(--surface);
      border:1px solid var(--border);padding:4px;border-radius:6px;width:fit-content}
    .tab{background:none;border:none;color:var(--muted);font-family:'DM Mono',monospace;
      font-size:0.78rem;letter-spacing:0.08em;text-transform:uppercase;
      padding:8px 22px;border-radius:4px;cursor:pointer;transition:all .2s}
    .tab.active{background:var(--accent);color:#0d0d0d;font-weight:500}
    .tab:not(.active):hover{color:var(--text);background:var(--border)}
    .tab.locked{opacity:.28;cursor:not-allowed;pointer-events:none}

    /* â”€â”€ PANELS â”€â”€ */
    .panel{display:none}
    .panel.active{display:block;animation:up .3s ease}
    @keyframes up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* â”€â”€ CARD â”€â”€ */
    .card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:26px 30px;margin-bottom:20px}
    .card-title{font-family:'DM Serif Display',serif;font-size:1.25rem;margin-bottom:18px}
    .card-title em{color:var(--accent2);font-style:italic}

    /* â”€â”€ LOADING STATE â”€â”€ */
    .load-state{text-align:center;padding:48px;color:var(--muted)}
    .load-state .icon{font-size:2rem;margin-bottom:10px;opacity:.35}
    .spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);
      border-top-color:var(--accent2);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:10px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* â”€â”€ FORM â”€â”€ */
    label{display:block;font-size:0.68rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
    input{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);
      font-family:'DM Mono',monospace;font-size:.9rem;padding:10px 14px;border-radius:4px;
      margin-bottom:16px;transition:border-color .2s;outline:none}
    input:focus{border-color:var(--accent)}

    /* â”€â”€ BUTTONS â”€â”€ */
    .btn{background:var(--accent);color:#0d0d0d;border:none;font-family:'DM Mono',monospace;
      font-size:.78rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;
      padding:10px 26px;border-radius:4px;cursor:pointer;transition:all .2s}
    .btn:hover{background:#d4ff66;transform:translateY(-1px)}

    /* â”€â”€ RESULT CARD â”€â”€ */
    #result-out{margin-top:22px}
    .res-card{background:var(--card);border:1px solid var(--border);border-radius:8px;overflow:hidden;animation:up .4s ease}
    .res-head{background:var(--surface);border-bottom:1px solid var(--border);
      padding:20px 28px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .res-head-left h2{font-family:'DM Serif Display',serif;font-size:1.5rem}
    .res-head-left p{font-size:.7rem;color:var(--muted);margin-top:3px;letter-spacing:.1em;text-transform:uppercase}
    .res-meta{display:flex;gap:22px;flex-wrap:wrap}
    .meta{text-align:right}
    .meta .v{font-family:'DM Serif Display',serif;font-size:1.4rem;color:var(--accent)}
    .meta .l{font-size:.62rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase}

    .stat-bar{padding:14px 28px;border-bottom:1px solid var(--border);display:flex;gap:28px;flex-wrap:wrap}
    .stat .sv{font-family:'DM Serif Display',serif;font-size:1.1rem}
    .stat .sl{font-size:.6rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase}
    .c-g{color:var(--pass)} .c-r{color:var(--danger)} .c-m{color:var(--muted)} .c-b{color:var(--accent2)}

    .q-wrap{padding:18px 28px;border-bottom:1px solid var(--border)}
    .q-title{font-size:.65rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:12px}
    .q-grid{display:flex;flex-wrap:wrap;gap:5px}
    .qc{width:34px;height:34px;border-radius:4px;display:flex;align-items:center;justify-content:center;
      font-size:.62rem;font-weight:500;border:1px solid transparent;cursor:default;position:relative}
    .qc.correct{background:rgba(96,240,144,.12);border-color:rgba(96,240,144,.3);color:var(--pass)}
    .qc.wrong{background:rgba(240,96,96,.10);border-color:rgba(240,96,96,.3);color:var(--danger)}
    .qc.skipped{background:rgba(255,255,255,.04);border-color:var(--border);color:var(--muted)}
    .qc:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;
      transform:translateX(-50%);background:#222;border:1px solid var(--border);color:var(--text);
      font-size:.6rem;padding:4px 8px;border-radius:3px;white-space:nowrap;z-index:10;pointer-events:none}

    .res-foot{padding:14px 28px;border-top:1px solid var(--border);display:flex;
      justify-content:space-between;align-items:center;background:var(--surface);flex-wrap:wrap;gap:8px}
    .badge-pass{font-family:'DM Serif Display',serif;font-size:.95rem;padding:5px 16px;border-radius:4px;
      background:rgba(96,240,144,.1);color:var(--pass);border:1px solid rgba(96,240,144,.25)}

    /* â”€â”€ LIST ALL TABLE â”€â”€ */
    .list-controls{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    .search-wrap{position:relative;flex:1;min-width:200px}
    .search-wrap input{padding-left:36px;margin-bottom:0}
    .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.85rem}
    .sort-btn{background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;
      font-size:.68rem;letter-spacing:.08em;text-transform:uppercase;padding:8px 14px;border-radius:4px;cursor:pointer;transition:all .2s}
    .sort-btn:hover,.sort-btn.active{border-color:var(--accent);color:var(--accent)}

    table{width:100%;border-collapse:collapse}
    thead th{font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);
      padding:10px 16px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none}
    thead th:hover{color:var(--text)}
    thead th .sort-arrow{margin-left:4px;opacity:.4}
    thead th.sorted .sort-arrow{opacity:1;color:var(--accent)}
    tbody tr{transition:background .15s}
    tbody tr:hover{background:rgba(255,255,255,.02)}
    tbody td{padding:10px 16px;font-size:.82rem;border-bottom:1px solid #1c1c1c}
    tbody tr:last-child td{border-bottom:none}
    .roll-cell{font-family:'DM Serif Display',serif;color:var(--accent);font-size:1rem}
    .grade-chip{display:inline-block;width:26px;height:26px;line-height:26px;text-align:center;
      border-radius:50%;font-size:.7rem;font-weight:500}
    .g-A{background:rgba(96,240,144,.15);color:var(--pass)}
    .g-B{background:rgba(96,212,240,.15);color:var(--accent2)}
    .g-C{background:rgba(200,240,96,.15);color:var(--accent)}
    .g-D{background:rgba(240,200,96,.15);color:#f0c060}
    .g-F{background:rgba(240,96,96,.15);color:var(--danger)}

    .list-summary{font-size:.7rem;color:var(--muted);padding:12px 0 4px}

    /* â”€â”€ ACCESS DENIED â”€â”€ */
    .denied{text-align:center;padding:60px 32px;border:1px solid var(--border);border-radius:8px;background:var(--card)}
    .denied .di{font-size:2.5rem;margin-bottom:16px;opacity:.35}
    .denied h3{font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:8px}
    .denied p{font-size:.78rem;color:var(--muted);line-height:1.7;max-width:340px;margin:0 auto}
    .denied code{background:var(--surface);border:1px solid var(--border);padding:2px 7px;border-radius:3px;font-size:.78rem;color:var(--accent2)}

    /* â”€â”€ TOAST â”€â”€ */
    #toast{position:fixed;bottom:28px;right:28px;background:var(--card);border:1px solid var(--border);
      color:var(--text);font-size:.78rem;padding:11px 18px;border-radius:6px;border-left:3px solid var(--accent);
      transform:translateY(70px);opacity:0;transition:all .3s ease;z-index:100;max-width:280px}
    #toast.show{transform:translateY(0);opacity:1}
    #toast.err{border-left-color:var(--danger)}

    ::-webkit-scrollbar{width:5px}
    ::-webkit-scrollbar-track{background:var(--bg)}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="logo">
      <h1>Result<em>Vault</em></h1>
      <p>Student Results Portal</p>
    </div>
    <div class="header-pills">
      <span id="file-pill" class="pill pill-file" style="display:none"></span>
      <span id="role-pill" class="pill pill-public">Public</span>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" id="tab-lookup"  onclick="switchTab('lookup')">ğŸ” Lookup</button>
    <button class="tab locked" id="tab-listall" onclick="switchTab('listall')">ğŸ“‹ List All</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â• LOOKUP â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="panel active" id="panel-lookup">
    <div id="loading-state" class="card">
      <div class="load-state">
        <div class="spinner"></div>
        <div>Loading result dataâ€¦</div>
      </div>
    </div>
    <div id="lookup-ready" style="display:none">
      <div class="card">
        <div class="card-title">Check <em>your result</em></div>
        <label for="roll-input">Roll Number</label>
        <input type="text" id="roll-input" placeholder="e.g.  01  or  02" autocomplete="off"
               onkeydown="if(event.key==='Enter') doLookup()"/>
        <button class="btn" onclick="doLookup()">Fetch Result</button>
      </div>
      <div id="result-out"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â• LIST ALL â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="panel" id="panel-listall">
    <div id="listall-denied" class="denied" style="display:none">
      <div class="di">â›’</div>
      <h3>Admin Access Required</h3>
      <p>The full results list is only visible to administrators.<br/>
      Add <code>?admin=YOUR_KEY</code> to the URL to unlock this tab.</p>
    </div>
    <div id="listall-content" style="display:none">
      <div class="card">
        <div class="card-title">All <em>Results</em></div>
        <div class="list-controls">
          <div class="search-wrap">
            <span class="search-icon">âŒ•</span>
            <input type="text" id="list-search" placeholder="Search roll number or nameâ€¦" oninput="renderList()"/>
          </div>
          <button class="sort-btn" id="sort-roll"  onclick="setSort('roll')"  title="Sort by roll">Roll â†•</button>
          <button class="sort-btn" id="sort-score" onclick="setSort('score')" title="Sort by score">Score â†•</button>
          <button class="sort-btn" id="sort-rank"  onclick="setSort('rank')"  title="Sort by rank">Rank â†•</button>
        </div>
        <div id="list-summary" class="list-summary"></div>
        <div id="list-body"></div>
      </div>
    </div>
  </div>

</div>
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG  â€” edit these two lines before deploying
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EXCEL_FILE = 'Block_1_test.xls';   // path relative to index.html in your repo
const ADMIN_KEY  = 'admin123';            // ?admin=admin123 in the URL to unlock List All

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IS_ADMIN = new URLSearchParams(window.location.search).get('admin') === ADMIN_KEY;
let students   = {};   // keyed by roll string
let sortKey    = 'roll';
let sortAsc    = true;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  // Admin UI
  if (IS_ADMIN) {
    document.getElementById('role-pill').className = 'pill pill-admin';
    document.getElementById('role-pill').textContent = 'Admin';
    document.getElementById('tab-listall').classList.remove('locked');
    document.getElementById('listall-denied').style.display  = 'none';
    document.getElementById('listall-content').style.display = '';
  } else {
    document.getElementById('listall-denied').style.display  = '';
    document.getElementById('listall-content').style.display = 'none';
  }
  loadExcel();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD EXCEL FROM REPO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadExcel() {
  const url = new URL(EXCEL_FILE, window.location.href).href;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const buf = await res.arrayBuffer();
    const wb  = XLSX.read(buf, { type: 'array' });
    students  = parseWorkbook(wb);
    const count = Object.keys(students).length;

    // Update UI
    const fp = document.getElementById('file-pill');
    fp.style.display = '';
    fp.textContent   = `${EXCEL_FILE} Â· ${count} students`;

    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('lookup-ready').style.display  = '';

    if (IS_ADMIN) renderList();
  } catch(e) {
    document.getElementById('loading-state').innerHTML = `
      <div class="load-state">
        <div class="icon">âš </div>
        <div style="color:var(--danger)">Could not load <strong>${EXCEL_FILE}</strong></div>
        <div style="font-size:.72rem;margin-top:6px;color:var(--muted)">${e.message}<br/>Make sure the file is in the same folder as index.html in your repo.</div>
      </div>`;
    toast('Failed to load Excel file.', true);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSE WORKBOOK
// Maps columns from your Block_1_test.xls format:
//   A=Exam  B=Exam Set  C=Roll No  D=Name  E=Total Marks
//   F=Grade  G=Rank  H=Correct  I=Incorrect  J=Not attempted
//   K=Subject  then triplets: Options | Key | Marks per question
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseWorkbook(wb) {
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows  = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'' });
  if (rows.length < 2) return {};

  const hdr  = rows[0].map(h => String(h).trim());
  const ci   = name => hdr.indexOf(name);

  const iRoll  = ci('Roll No');
  const iName  = ci('Name');
  const iTotal = ci('Total Marks');
  const iGrade = ci('Grade');
  const iRank  = ci('Rank');
  const iCorr  = ci('Correct Answers');
  const iWrong = ci('Incorrect Answers');
  const iSkip  = ci('Not attempted');
  const iExam  = ci('Exam');
  const iSet   = ci('Exam Set');

  // Collect all "Q N Marks" column positions
  const qCols = hdr.reduce((a, h, i) => { if (/^Q \d+ Marks$/i.test(h)) a.push(i); return a; }, []);

  const out = {};
  for (let r = 1; r < rows.length; r++) {
    const row  = rows[r];
    const roll = String(row[iRoll] ?? '').trim();
    const name = String(row[iName] ?? '').trim();
    if (!roll || !name) continue;

    const questions = qCols.map((mi, qi) => {
      const marks    = parseFloat(row[mi]) || 0;
      const studentA = String(row[mi - 2] ?? '').trim();
      const correctA = String(row[mi - 1] ?? '').trim();
      let status = 'skipped';
      if (studentA !== '' && studentA !== '0') status = marks > 0 ? 'correct' : 'wrong';
      return { q: qi + 1, marks, studentAns: studentA, correctAns: correctA, status };
    });

    out[roll] = {
      roll, name,
      exam:         String(row[iExam]  ?? '').trim(),
      examSet:      String(row[iSet]   ?? '').trim(),
      totalMarks:   parseFloat(row[iTotal]) || 0,
      grade:        String(row[iGrade] ?? '').trim(),
      rank:         String(row[iRank]  ?? '').trim(),
      correct:      Number(row[iCorr]) || 0,
      incorrect:    Number(row[iWrong])|| 0,
      notAttempted: Number(row[iSkip]) || 0,
      questions,
    };
  }
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  if (name === 'listall' && !IS_ADMIN) { toast('Admin access required.', true); return; }
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  document.getElementById('tab-'   + name).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOOKUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLookup() {
  const raw = document.getElementById('roll-input').value.trim();
  const out = document.getElementById('result-out');
  if (!raw) { toast('Enter a roll number.', true); return; }

  // flexible matching: exact â†’ zero-padded 2 â†’ zero-padded 3 â†’ name
  const r = students[raw]
         ?? students[raw.padStart(2, '0')]
         ?? students[raw.padStart(3, '0')]
         ?? Object.values(students).find(s => s.name.toLowerCase() === raw.toLowerCase());

  if (!r) {
    out.innerHTML = `<div class="card" style="text-align:center;padding:40px;color:var(--muted)">
      <div style="font-size:2rem;margin-bottom:8px;opacity:.3">âœ¦</div>
      <div>No result found for <span style="color:var(--accent)">${raw}</span></div>
      <div style="font-size:.72rem;margin-top:6px">Check the roll number and try again.</div>
    </div>`;
    return;
  }

  const totalQ    = r.correct + r.incorrect + r.notAttempted;
  const gradeClass = 'g-' + (r.grade || calcGrade(totalQ > 0 ? r.correct / totalQ * 100 : 0));

  const qGrid = r.questions.map(q =>
    `<div class="qc ${q.status}" data-tip="Q${q.q} Â· You: ${q.studentAns||'â€”'} Â· Key: ${q.correctAns} Â· ${q.marks > 0 ? '+' : ''}${q.marks}">${q.q}</div>`
  ).join('');

  out.innerHTML = `
  <div class="res-card">
    <div class="res-head">
      <div class="res-head-left">
        <h2>${r.name}</h2>
        <p>Roll ${r.roll}${r.exam ? ' Â· ' + r.exam : ''}${r.examSet ? ' Â· Set ' + r.examSet : ''}</p>
      </div>
      <div class="res-meta">
        <div class="meta"><div class="v">${r.totalMarks}</div><div class="l">Score</div></div>
        <div class="meta"><div class="v">${r.correct}/${totalQ}</div><div class="l">Correct</div></div>
        <div class="meta"><div class="v" style="font-size:1.4rem">
          <span class="grade-chip ${gradeClass}">${r.grade || 'â€”'}</span>
        </div><div class="l">Grade</div></div>
      </div>
    </div>

    <div class="stat-bar">
      <div class="stat"><div class="sv c-g">${r.correct}</div><div class="sl">âœ“ Correct</div></div>
      <div class="stat"><div class="sv c-r">${r.incorrect}</div><div class="sl">âœ— Wrong</div></div>
      <div class="stat"><div class="sv c-m">${r.notAttempted}</div><div class="sl">â€” Skipped</div></div>
      <div class="stat"><div class="sv c-b">#${r.rank || 'â€”'}</div><div class="sl">Rank</div></div>
    </div>

    ${r.questions.length ? `
    <div class="q-wrap">
      <div class="q-title">Question breakdown â€” hover each cell for details</div>
      <div class="q-grid">${qGrid}</div>
    </div>` : ''}

    <div class="res-foot">
      <span style="font-size:.7rem;color:var(--muted)">Source: ${EXCEL_FILE}</span>
      <span class="badge-pass">Score: ${r.totalMarks}</span>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIST ALL  (admin only)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSort(key) {
  if (sortKey === key) sortAsc = !sortAsc;
  else { sortKey = key; sortAsc = key === 'roll'; }
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('sort-' + key).classList.add('active');
  renderList();
}

function renderList() {
  const q = (document.getElementById('list-search')?.value || '').toLowerCase();
  let rows = Object.values(students).filter(s =>
    !q || s.roll.toLowerCase().includes(q) || s.name.toLowerCase().includes(q)
  );

  // sort
  rows.sort((a, b) => {
    let av, bv;
    if (sortKey === 'roll')  { av = a.roll.padStart(5,'0');  bv = b.roll.padStart(5,'0'); }
    if (sortKey === 'score') { av = a.totalMarks;            bv = b.totalMarks; }
    if (sortKey === 'rank')  { av = parseInt(a.rank)||9999;  bv = parseInt(b.rank)||9999; }
    if (av < bv) return sortAsc ? -1 :  1;
    if (av > bv) return sortAsc ?  1 : -1;
    return 0;
  });

  const total = Object.keys(students).length;
  document.getElementById('list-summary').textContent =
    `Showing ${rows.length} of ${total} student${total !== 1 ? 's' : ''}`;

  if (!rows.length) {
    document.getElementById('list-body').innerHTML =
      `<div style="text-align:center;padding:32px;color:var(--muted);font-size:.82rem">No matching records.</div>`;
    return;
  }

  const arrow = dir => `<span class="sort-arrow">${dir === 'asc' ? 'â†‘' : 'â†“'}</span>`;
  const colArrow = key => sortKey === key ? arrow(sortAsc ? 'asc' : 'desc') : '<span class="sort-arrow">â†•</span>';

  document.getElementById('list-body').innerHTML = `
  <table>
    <thead>
      <tr>
        <th onclick="setSort('roll')"  class="${sortKey==='roll' ?'sorted':''}">Roll  ${colArrow('roll')}</th>
        <th>Name</th>
        <th onclick="setSort('score')" class="${sortKey==='score'?'sorted':''}">Score ${colArrow('score')}</th>
        <th>Correct</th>
        <th>Wrong</th>
        <th>Skipped</th>
        <th onclick="setSort('rank')"  class="${sortKey==='rank' ?'sorted':''}">Rank  ${colArrow('rank')}</th>
        <th>Grade</th>
      </tr>
    </thead>
    <tbody>
      ${rows.map(s => {
        const g = s.grade || calcGrade(
          (s.correct + s.incorrect + s.notAttempted) > 0
            ? s.correct / (s.correct + s.incorrect + s.notAttempted) * 100 : 0
        );
        return `<tr>
          <td class="roll-cell">${s.roll}</td>
          <td>${s.name}</td>
          <td style="color:var(--accent);font-weight:500">${s.totalMarks}</td>
          <td style="color:var(--pass)">${s.correct}</td>
          <td style="color:var(--danger)">${s.incorrect}</td>
          <td style="color:var(--muted)">${s.notAttempted}</td>
          <td style="color:var(--accent2)">${s.rank || 'â€”'}</td>
          <td><span class="grade-chip g-${g}">${g}</span></td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcGrade(pct) {
  if (pct >= 90) return 'A';
  if (pct >= 75) return 'B';
  if (pct >= 60) return 'C';
  if (pct >= 40) return 'D';
  return 'F';
}

let toastTimer;
function toast(msg, err = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show' + (err ? ' err' : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.className = '', 3200);
}
</script>
</body>
</html>
